## Running CTS by hand
```bash
consul-terraform-sync start -config-file=cts-firewall.hcl
```

## Example tfvars
```hcl
# This file is generated by Consul-Terraform-Sync.
#
# The HCL blocks, arguments, variables, and values are derived from the
# operator configuration for Consul-Terraform-Sync. Any manual changes to
# this file may not be preserved and could be overwritten by a subsequent
# update.
#
# Task: firewall
# Description: add firewall changes for every nginx node

services = {
  "standalone/nginx.nginx-1.default.nomad" = {
    id              = "standalone/nginx"
    name            = "standalone/nginx"
    kind            = ""
    address         = "10.154.0.31"
    port            = 80
    meta            = {}
    tags            = ["nginx"]
    namespace       = "default"
    status          = "passing"
    node            = "nginx-1"
    node_id         = "79e76b20-73a9-592a-75ef-999c25c631fd"
    node_address    = "10.154.0.31"
    node_datacenter = "nomad"
    node_tagged_addresses = {
      lan      = "10.154.0.31"
      lan_ipv4 = "10.154.0.31"
      wan      = "10.154.0.31"
      wan_ipv4 = "10.154.0.31"
    }
    node_meta = {
      consul-network-segment = ""
      consul-version         = "1.19.2"
    }
    cts_user_defined_meta = {}
  },
}
```

## More relaisitc TF
```hcl
variable "services" {
  description = "Consul services monitored by Consul Terraform Sync"
  type = map(
    object({
      id        = string
      name      = string
      kind      = string
      address   = string
      port      = number
      meta      = map(string)
      tags      = list(string)
      namespace = string
      status    = string

      node                  = string
      node_id               = string
      node_address          = string
      node_datacenter       = string
      node_tagged_addresses = map(string)
      node_meta             = map(string)

      cts_user_defined_meta = map(string)
    })
  )
}

# Filtering services to create firewall rules only for "standalone/nginx"
locals {
  nginx_services = { for k, v in var.services : k => v if v.name == "standalone/nginx" }
}

resource "google_compute_firewall" "nginx_service_firewalls" {
  for_each = local.nginx_services

  name    = "firewall-${each.value.address}"
  network = "default" # Replace with your network if it's not "default"

  allow {
    protocol = "tcp"
    ports    = [each.value.port == 80 ? "80" : "default"]
  }

  # Target tags retrieved from each service's tags in Consul
  target_tags = each.value.tags

  # Restricting the source to the service's specific address
  source_ranges = [each.value.address]

  # Optional description for context in GCP console
  description = "Firewall rule for ${each.value.name} with address ${each.value.address} on port 80"
}
```